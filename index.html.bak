<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="A single-page template generated by Tizen Web IDE"/>

    <title>IMAGE PHOTOSHOP</title>

    <link rel="stylesheet" href="./css/jquery.mobile-1.3.2.css"/>
    <script type="text/javascript" src="./js/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="./js/jquery.mobile-1.3.2.js"></script>
    <script type="text/javascript" src="./js/main.js"></script>
    <link rel="stylesheet" href="./css/style.css" />
    
    <link rel="stylesheet" href="styles.css" />
    <script src="pixastic.js"></script> 
    <script src="pixastic.effects.js"></script>
    <script src="pixastic.worker.js"></script>
    <script src="pixastic.worker.control.js"></script>
    
    <style>
    #input-Pic {
    position:absolute;
    /*width:150px;*/
    height:130px;
    
    }
    
    #show-Pic {
    visibility:hidden;
    position:absolute;
    }
    
    #showArea {
    height:15px;
    overflow:hidden;
    position:relative;
    }
    
    img {
    position:absolute;
    margin-left:auto;
    margin-right:auto;
    left:0;
    right:0;
    }
       
    #save-canvas {
    visibility:hidden;
    }
    
    #downloadLnk {
    cursor : pointer;
    text-align : center;
    }
    
    </style>
    
    
    
    <script>
    
	// When application is loaded
    window.onload = function() {
    	setPhotoShop();
    }

	// When image process button is clicked
	function doPixasticFunc(test) {
		var img = document.getElementById("show-Pic"); //input image (original size)
		// output image : view mode
		var canvas = document.getElementById("output-canvas");
		// output image : save mode
		save_canvas = document.getElementById("save-canvas");
		var ctx = canvas.getContext("2d");
		save_ctx = save_canvas.getContext("2d");
		var P; 

		canvas.style.display = "none";
		canvas.width = 200; // set temp width
		canvas.height = 150; // set temp height
		canvas.title = test.effect; // image process func name
		
		save_canvas.style.display = "none";
		save_canvas.width = img.width; // original width
		save_canvas.height = img.height; // original height
		
		var sx = img.width * (130/img.height);
		var sy = 130;

		px = (canvas.width - sx) / 2;
		// py = (canvas.height - sy) / 2;
		save_ctx.drawImage(img, 0, 0, img.width, img.height);
		// set the coordinate of view image
		ctx.drawImage(img, 0, 0, img.width, img.height, px, 0, sx, sy);

		// set the image file name to save
		var filepath = document.getElementById("take-Pic").value.split("\\");
		var filename = filepath[2].split(".");
		var filename = "edit_" + filename[0] + ".png";

		// set download func (browser)
		var saveSkill = document.getElementById("downloadLnk");
		saveSkill.setAttribute("download", filename);
		
		P = new Pixastic(ctx);
		// Apply image processing func
		// After image processing applied, you can save file by click text "Save Image File" in simulator
		P[test.effect](test.options).done(function() {
			canvas.style.display = "block";	
			downloadLnk.addEventListener('click', download_pc, false);
			
			save_P = new Pixastic(save_ctx);
			save_P[test.effect](test.options).done();

		}, function(P){
		});
		
		
	}
    
	function setPhotoShop() {
		
		// set image processing func
		var tests = [ { 
				effect : "findedges"
				}, { 
		    	effect : 'mosaic', 
				options : { 
					blockSize : 8 
			    	} 
				}, { 
				effect : "emboss", 
				options : { 
				    amount : 0.5, 
				    angle : 135 / 180 * Math.PI 
				    } 
				}, { 
				effect : 'equalize', 
				options : { 
				    } 
				}, {
				effect : "invert"
				}, {
				effect : "noise", 
				options : { 
				     amount : 0.5, 
				     strength : 0.5, 
				     mono : true //100 line
				     } 					
				}
									 
			];
		
		var ul = document.getElementById("testlist");
		var li;

		// create image processing list
		for(var i=0; i<tests.length; i++) {
			li = document.createElement("li");
			li.innerHTML = tests[i].effect;
			li.setAttribute("data-test", i);
			ul.appendChild(li);
		}

		// When click, perform image processing
		ul.addEventListener("click", function(e) {
			var target = e.target || e.srcElement;
			var test;
			if(target.tagName == "LI") {
				test = tests[target.getAttribute("data-test")];
				doPixasticFunc(test);
			}
		}, false)
	}

	// save the changed image
	function download_pc() {
		var canvas = document.getElementById("save-canvas");
		
		var dt = canvas.toDataURL('image/jpeg');
	    this.href = dt;
	    //alert("success");
	}
	
    </script>
</head>

<body>
	<div style="height:200px">
		<form>
	    	<input type="file" id="take-Pic" accept="image/*">
	    	<div id="showArea"><img src="about:blank" alt="IMG" id="show-Pic"></div>
	    	<img src="icon.png" alt="IMG" id="input-Pic">
	    </form>
    </div>
    <div>
    	<div style="text-align:center;"><ul id="testlist"></ul></div>
    	<div id="canvasArea" align="center">
    		<a id="downloadLnk">Save Image File</a> 
    		<canvas id="output-canvas" style="display:none;"></canvas>
    		<canvas id="save-canvas" style="display:none;"></canvas>
    	</div>    	
    </div>
    
    <script>
    ( function() {
        // variables of input and img
        var takePic = document.querySelector("#take-Pic");
        var showPic = document.querySelector("#show-Pic");
        var inputPic = document.querySelector("#input-Pic");
        
        
        if(takePic && showPic) {
			// runs when you use input
			// If selected file is exist,
			// Get the selected image file on the display area.
			takePic.onchange = function (swap) {
				var files = swap.target.files;
				var file;
				if(files && files.length > 0) {
					file = files[0];
					try {
						var fileReader = new FileReader();
						fileReader.onload = function (swap) {
							showPic.src = swap.target.result;
							inputPic.src = swap.target.result;
						};
						fileReader.readAsDataURL(file);	
						console.log("file",file);
					}
					catch(e) {
						showPic.alt = "error";
					}
				}
			};
        }
    })();
    </script>
    
</body>
</html>